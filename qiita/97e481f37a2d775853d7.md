<!--
title:   å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’è¿½ã„ãªãŒã‚‰ARKitã‚’è©¦ã—ã¦ã¿ã‚ˆã†
tags:    AR,ARKit,Swift,WWDC,Xcode
id:      97e481f37a2d775853d7
private: false
-->
# 0. ã¯ã˜ã‚ã«

WWDC2017å§‹ã¾ã‚Šã¾ã—ãŸã­ã€‚

Keynoteã§ç™ºè¡¨ã•ã‚Œã€ãªã«ã‚ˆã‚Šã‚‚è©±é¡Œã«ãªã£ãŸã®ãŒ**ARKit**ã€‚æ—©é€Ÿè©¦ã—ã¦ã„ããŸã„ã®ã§ã™ãŒã‚‚ã¡ã‚ã‚“ã¾ã ã¾ã æ—¥æœ¬èªã®æƒ…å ±ã¯å°‘ãªã„ã§ã™ï¼ˆQiitaã§ã¯ãªãœã‹Unityã§ä½¿ã†æ–¹æ³•ãŒå…ˆã«ã‚ãŒã£ã¦ã„ã¾ã™ã­...ï¼‰


ã¨ã„ã†ã‚ã‘ã§[å…¬å¼ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://developer.apple.com/documentation/arkit)ã‚’å‚è€ƒã«ã€æ—©é€ŸARKitã‚’å‹•ã‹ã—ã¦ã¿ã‚ˆã†ã¨ã„ã†ã®ãŒä»Šå›ã®è¶£æ—¨ã§ã™ã€‚
ç’°å¢ƒã¯ã‚‚ã¡ã‚ã‚“ã®ã“ã¨Xcode9 betaã§ã™ã€‚

æœ‰æ–™ãƒ‡ãƒ™ãƒ­ãƒƒãƒ‘ãƒ¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãªã„ã¨ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã§ããªã„ï¼ˆï¼Ÿï¼‰ã‚ˆã†ãªã®ã§æ°—ã«ãªã‚‹äººã¯ã‚¢ãƒ—ãƒªã‚’ãƒªãƒªãƒ¼ã‚¹ã—ã¦ã„ã‚‹äººã«é ¼ã¿è¾¼ã‚“ã§ã¿ã¾ã—ã‚‡ã†ã€‚

ä»Šå›ã®ã‚³ãƒ¼ãƒ‰ã¯ã“ã¡ã‚‰ã§ã™ã€‚ï¼ˆARKitSCNSampleãŒSceneKitã®ã€ARKitSKSampleãŒSpriteKitã®ã€ARKitMetalSampleãŒMetalã®ã‚µãƒ³ãƒ—ãƒ«ã«ãªã£ã¦ã„ã¾ã™ã€‚ï¼‰

[touyou/ARKitSample](https://github.com/touyou/ARKitSample)

# 1. ARã“ã¨ã¯ã˜ã‚ã€œSceneKitç·¨ã€œ

ã¾ãšæœ€åˆã«å¿…è¦ãªã®ã¯[ARSession](https://developer.apple.com/documentation/arkit/arsession)ã§ã™ã€‚ã“ã‚Œã¯ãã®åã‹ã‚‰ã‚‚åˆ†ã‹ã‚‹é€šã‚ŠARKitãŒã‚«ãƒ¡ãƒ©ã‚„ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³ã‚»ãƒ³ã‚µã‚’ç®¡ç†ã‚’ã™ã‚‹ãŸã‚ã®shared objectã«ãªã‚Šã¾ã™ã€‚
ã“ã‚Œã‚’ç›´æ¥å©ã„ã¦ã‚„ã‚Œã°ã€è‡ªåˆ†ã§ç”¨æ„ã—ãŸCameraViewä¸Šã«ARã‚’å®Ÿç¾ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã¨ã„ã†ã‚ˆã†ãªã“ã¨ãŒ[Understanding Augmented Reality](https://developer.apple.com/documentation/arkit/understanding_augmented_reality)ã«æ›¸ã„ã¦ã‚ã‚Šã¾ã™ãŒã€ä»Šå›ã¯ç°¡å˜ã®ãŸã‚[Building a Basic AR Experience](https://developer.apple.com/documentation/arkit/building_a_basic_ar_experience)ã«ã‹ã‹ã‚Œã¦ã„ã‚‹ã‚ˆã†ã«ç”¨æ„ã•ã‚Œã¦ã„ã‚‹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¨SceneKitã‚„SpriteKitã‚’çµ„ã¿åˆã‚ã›ã¦ä½œã£ã¦ã„ãã¾ã—ã‚‡ã†ã€‚

Xcode9 betaã§æ–°è¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã™ã‚‹ã¨*Augumented Reality App*ã¨ã„ã†é …ç›®ãŒè¿½åŠ ã•ã‚Œã¦ã„ã‚‹ã®ã§ã“ã‚Œã‚’é¸æŠã—ã¾ã™ã€‚
ä½¿ã†ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¨ã—ã¦ã¯SceneKit,SpriteKit,Metalã®ä¸‰ç¨®é¡ãŒé¸æŠã§ãã¾ã™ã€‚ä»Šå›ã¯ã›ã£ã‹ãã®ARã§ã™ã®ã§3Dã‚‚æ‰±ãˆã‚‹SceneKitã‚’é¸æŠã—ã¾ã—ãŸã€‚

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã™ã‚‹ã¨SceneKitãŠãªã˜ã¿ã®èˆ¹ã®ãƒ¢ãƒ‡ãƒ«ãŒå…¥ã£ãŸãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒã§ãã¾ã™ã€‚
ViewControllerã¯ã“ã‚“ãªæ„Ÿã˜ã€‚

```swift:ViewController.swift
import UIKit
import SceneKit
import ARKit

class ViewController: UIViewController, ARSCNViewDelegate {

    @IBOutlet var sceneView: ARSCNView!
    
    override func viewDidLoad() {
        super.viewDidLoad()
        
        // Set the view's delegate
        sceneView.delegate = self
        
        // Show statistics such as fps and timing information
        sceneView.showsStatistics = true
        
        // Create a new scene
        let scene = SCNScene(named: "art.scnassets/ship.scn")!
        
        // Set the scene to the view
        sceneView.scene = scene
    }
    
    override func viewWillAppear(_ animated: Bool) {
        super.viewWillAppear(animated)
        
        // Create a session configuration
        let configuration = ARWorldTrackingSessionConfiguration()
        
        // Run the view's session
        sceneView.session.run(configuration)
    }
    
    override func viewWillDisappear(_ animated: Bool) {
        super.viewWillDisappear(animated)
        
        // Pause the view's session
        sceneView.session.pause()
    }

    override func didReceiveMemoryWarning() {
        super.didReceiveMemoryWarning()
        // Release any cached data, images, etc that aren't in use.
    }

    // MARK: - ARSCNViewDelegate
    
/*
    // Override to create and configure nodes for anchors added to the view's session.
    func renderer(_ renderer: SCNSceneRenderer, nodeFor anchor: ARAnchor) -> SCNNode? {
        let node = SCNNode()
     
        return node
    }
*/
    
    func session(_ session: ARSession, didFailWithError error: Error) {
        // Present an error message to the user
        
    }
    
    func sessionWasInterrupted(_ session: ARSession) {
        // Inform the user that the session has been interrupted, for example, by presenting an overlay
        
    }
    
    func sessionInterruptionEnded(_ session: ARSession) {
        // Reset tracking and/or remove existing anchors if consistent tracking is required
        
    }
}

```

ã¾ãšæœ€åˆã«ç›®ãŒã¨ã¾ã‚‹ã®ã¯`ARSCNView`ã§ã™ã­ã€‚æ—¢å­˜ã®æ¥é ­è¾ã«ã•ã‚‰ã«`AR`ãŒã¤ãã‹ãŸã¡ã§`ARKit`ã®ã‚µãƒãƒ¼ãƒˆã™ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªç¾¤ã¯å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚

delegateã¨ã—ã¦`ARSCNViewDelegate`ãŒã‚ã‚Šã€ã“ã‚Œã«ã¯ã‚¢ãƒ³ã‚«ãƒ¼ãƒã‚¤ãƒ³ãƒˆãŒç½®ã‹ã‚ŒãŸã¨ã“ã‚ã«SCNNodeã‚’ç½®ãï¼ˆï¼Ÿï¼‰`renderer`ã¨ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒå¤±æ•—ã—ãŸæ™‚ã®ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºç”¨ã®ãŸã‚ã®`session`ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒä¸­æ–­ã•ã‚ŒãŸã¨ãã®ãŸã‚ã®`sessionWasInterrupted`ã‚„`sessionInterruptionEnded`ãŒç”¨æ„ã•ã‚Œã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚ã‚¨ãƒ©ãƒ¼å‡¦ç†å¤šã„ãª...


ARSessionã®è¨­å®šã¯`viewWillAppear`å†…ã§è¡Œã‚ã‚Œã¦ã„ã‚‹ã‚ˆã†ã§ã™ãŒã€ã“ã“ã§ã•ã£ããè¨˜äº‹ã®ã¨ãŠã‚Šã«è¨­å®šã‚’å¤‰ãˆã¦ã¿ã¾ã—ã‚‡ã†ã€‚

```swift:viewWillAppear
override func viewWillAppear(_ animated: Bool) {
    super.viewWillAppear(animated)
    
    // Create a session configuration
    let configuration = ARWorldTrackingSessionConfiguration()
    configuration.planeDetection = .horizontal
    
    // Run the view's session
    sceneView.session.run(configuration)
}
```

ã¾ãš`ARWorldTrackingSessionConfiguration`ãŒARã®è¨­å®šã‚¯ãƒ©ã‚¹ã«ãªã‚‹ã‚ˆã†ã§ã™ã€‚ARSCNViewãŒARSessionã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’æŒã£ã¦ã„ã‚‹ã®ã§ãã“ã§ã“ã®è¨­å®šã‚¯ãƒ©ã‚¹ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’runã—ã¦ã‚ã’ã¾ã™ã€‚
è¿½åŠ ã—ãŸplaneDetectionã¯è‡ªå‹•ã§æ¤œçŸ¥ã™ã‚‹å¹³é¢ã®æ–¹å‘ã‚’è¨­å®šã—ã¾ã™ï¼ˆç¾çŠ¶horizontalã—ã‹ãªã•ã’ï¼Ÿï¼‰
ã“ã‚Œã§è‡ªå‹•ã§æ°´å¹³é¢ã‚’æ¤œçŸ¥ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

# 2. ARã—ã¦ã¿ã‚‹

ã‚‚ã£ã¨ã‚‚æ‰‹è»½ãªARã¨ã—ã¦å¹³é¢ã®èªè­˜ãŒã‚ã’ã‚‰ã‚Œã¾ã™ã€‚ARKitã§ã¯å…ˆç¨‹ã®configurationè¨­å®šã«ã‚ˆã£ã¦æ°´å¹³é¢ã‚’è‡ªå‹•ã§èªè­˜ã—ãã“ã«`ARAnchor`ã‚’è¨­ç½®ã—ã¦ãã‚Œã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚delegateãƒ¡ã‚½ãƒƒãƒ‰ã§ã‚ã‚‹`renderer`ã«ã“ã®ã‚¢ãƒ³ã‚«ãƒ¼ãƒã‚¤ãƒ³ãƒˆã¯æ¸¡ã•ã‚Œã‚‹ãŸã‚ã€ã“ã®delegateãƒ¡ã‚½ãƒƒãƒ‰ã®ä¸­ã§å¹³é¢ã«ç½®ã„ã¦ãŠããŸã„Nodeã‚’è¨˜è¿°ã—ã¦ã‚ã’ã¾ã™ã€‚

å…¬å¼ã®ä¾‹ã¨ã—ã¦ã¯ã“ã¡ã‚‰ï¼ˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«ã‚ã‚‰ã‹ã˜ã‚ç”¨æ„ã•ã‚Œã¦ã„ã‚‹delegateãƒ¡ã‚½ãƒƒãƒ‰ã¨ã¯è‹¥å¹²ã“ã¨ãªã‚‹ã®ã§æ³¨æ„ã—ã¾ã—ã‚‡ã†ã€‚ï¼‰

```swift:renderer
    func renderer(_ renderer: SCNSceneRenderer, didAdd node: SCNNode, for anchor: ARAnchor) {
        guard let planeAnchor = anchor as? ARPlaneAnchor else { return }
        
        let plane = SCNPlane(width: CGFloat(planeAnchor.extent.x), height: CGFloat(planeAnchor.extent.z))
        let planeNode = SCNNode(geometry: plane)
        planeNode.position = SCNVector3Make(planeAnchor.center.x, 0, planeAnchor.center.z)
        planeNode.transform = SCNMatrix4MakeRotation(-Float.pi / 2, 1, 0, 0)
        
        node.addChildNode(planeNode)
    }
```

ã“ã®ã‚µãƒ³ãƒ—ãƒ«ã§ã¯å¹³é¢ãƒãƒ¼ãƒ‰ã‚’ã‚¢ãƒ³ã‚«ãƒ¼ãƒã‚¤ãƒ³ãƒˆã‚’ã‚‚ã¨ã«è¨­ç½®ã—ã¦ã„ã¾ã™ã€‚ã‚¢ãƒ³ã‚«ãƒ¼ã®åº§æ¨™ç³»ã§ã®åºƒãŒã‚ŠãŒ`planeAnchor.extent`ãªã®ã§ãã‚Œã«ã‚ã‚ã›ãŸå¹³é¢ãƒãƒ¼ãƒ‰ã‚’ã¤ãã£ã¦ã„ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã£ã¦æ°´å¹³é¢ã«å¹³é¢ã®ãƒãƒ¼ãƒ‰ãŒè¨­ç½®ã•ã‚Œã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚

# 3. å®Ÿè¡Œã—ã¦ã¿ã‚ˆã†

å®Ÿè¡Œã¯ã‚‚ã¡ã‚ã‚“iOS11ã®å…¥ã£ãŸå®Ÿæ©Ÿã¨ã„ã†ã“ã¨ã«ãªã‚Šã¾ã™ã€‚ï¼ˆã‚·ãƒ¥ãƒŸãƒ¬ãƒ¼ã‚¿ãƒ¼ã§ã‚‚è½ã¡ãšã«å‹•ãã¯ã—ã¾ã™ã€‚ï¼‰

~~åƒ•è‡ªèº«ã¯betaç‰ˆã®äººæŸ±ã«ãªã£ã¦ã„ã‚‹iPadã§è©¦ãã†ã¨ã—ãŸã®ã§ã™ãŒã¾ã•ã‹ã®iOS11å¯¾è±¡å¤–ã«ãªã£ã¦ã—ã¾ã£ã¦ã„ãŸã‚‰ã—ãã€å…¥ã‚Œã‚‰ã‚Œãªã‹ã£ãŸãŸã‚æ–­å¿µã—ã¾ã—ãŸã€‚ã€‚ã€‚
æ˜¯éå‹•ãæ–¹ã¯è©¦ã—ã¦ã¿ã¦ãã ã•ã„ã€‚~~
~~æœ¬æ—¥å®Ÿæ©Ÿã‚’æŒã£ã¦ã„ã‚‹äººã«å”åŠ›ã—ã¦ã„ãŸã ãã“ã¨ã«ãªã£ãŸã®ã§å¾Œã»ã©æ›´æ–°ã—ã¾ã™ã€‚~~

SceneKitã‚µãƒ³ãƒ—ãƒ«ãŒä½•æ•…ã‹å‹•ã„ã¦ãã‚Œãªã‹ã£ãŸã®ã§ãã®ä»–ã®ã‚‚ã®ã§ã™ã€‚

![IMG_0327.PNG](https://qiita-image-store.s3.amazonaws.com/0/10943/5c981766-7f21-955d-cf29-ace9218d6fd5.png)
<img alt="IMG_0329.PNG" src="https://qiita-image-store.s3.amazonaws.com/0/10943/c80db6cd-df49-5b9e-ae89-6cd99db2cdad.png">



# 4. ä»–ã«ã‚‚ãŸã‚ã—ã¦ã¿ã‚ˆã†

## 4-2. 2Dã‚’ç¾å®Ÿç©ºé–“ã¸

SceneKitãŒ3Dæ‹…å½“ãªã‚‰ã°ã€SpriteKitã¯2Dæ‹…å½“ã§ã™ã€‚
ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã§ã¯ã‚ã‚‰ã‹ã˜ã‚ã‚¢ãƒ³ã‚«ãƒ¼ãƒã‚¤ãƒ³ãƒˆã«ğŸ‘¾ã‚’è¡¨ç¤ºã™ã‚‹ã‚ˆã†ã«ä»¥ä¸‹ã®ãƒ‡ãƒªã‚²ãƒ¼ãƒˆãƒ¡ã‚½ãƒƒãƒ‰ãŒå®Ÿè£…ã•ã‚Œã¦ã„ã¾ã™ã€‚

```swift:view
    func view(_ view: ARSKView, nodeFor anchor: ARAnchor) -> SKNode? {
        // Create and configure a node for the anchor added to the view's session.
        let labelNode = SKLabelNode(text: "ğŸ‘¾")
        labelNode.horizontalAlignmentMode = .center
        labelNode.verticalAlignmentMode = .center
        return labelNode;
    }
```

ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã‚ã‚‹é€šã‚Šã€ã“ã®ã‚¢ãƒ³ã‚«ãƒ¼ãƒã‚¤ãƒ³ãƒˆã‚’è‡ªä½œã™ã‚‹ã«ã¯ãŸã¨ãˆã°ã“ã®ã‚ˆã†ã«æ›¸ãã¾ã™ï¼ˆMetalã®ã‚µãƒ³ãƒ—ãƒ«ã«ã‚ã£ãŸã‚³ãƒ¼ãƒ‰ã‚’çœŸä¼¼ã—ã¦ã‚¿ãƒƒãƒ—ã•ã‚ŒãŸã‚‰å‡ºç¾ã™ã‚‹ã‚ˆã†ã«ã—ã¾ã—ãŸã€‚ï¼‰

```swift:handleTap
    @objc
    func handleTap(gestureRecognize: UITapGestureRecognizer) {
        // Create anchor using the camera's current position
        if let currentFrame = sceneView.session.currentFrame {
            
            // Create a transform with a translation of 0.2 meters in front of the camera
            var translation = matrix_identity_float4x4
            translation.columns.3.z = -0.2
            let transform = simd_mul(currentFrame.camera.transform, translation)
            
            // Add a new anchor to the session
            let anchor = ARAnchor(transform: transform)
            sceneView.session.add(anchor: anchor)
        }
    }
```

ã“ã‚Œã«ã‚ˆã£ã¦å‰æ–¹ï¼ï¼ï¼’ãƒ¡ãƒ¼ãƒˆãƒ«ã«ARAnchorãŒç½®ã‹ã‚Œã¾ã™ã€‚translationã§åº§æ¨™ã‚’0.2ãƒ¡ãƒ¼ãƒˆãƒ«åˆ†å¹³è¡Œç§»å‹•ã•ã›ãŸã¨ã„ã†ã“ã¨ã§ã™ã­ã€‚

## 4-3. Metalã§è‡ªä½œã—ã¦ã¿ã‚ˆã†

ä»Šã¾ã§SceneKitã‚„SpriteKitã¨ãªã£ã¦ã„ãŸã¨ã“ã‚ã‚’Metalã«ã—ã¦ã¤ãã‚‹ã¨ã€Rendererã‚¯ãƒ©ã‚¹ãŒå®Ÿè£…ã•ã‚ŒãŸã‹ãªã‚Šé‡ã‚ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒã§ãã¾ã™ã€‚ä»–ã¨ã®é•ã„ã¯è‡ªåˆ†ã§ARSessionã‚’ç®¡ç†ã—ãªã‘ã‚Œã°ã„ã‘ãªã„ã¨ã„ã†ã¨ã“ã‚ã§ã™ã€‚ã§ã™ãŒé€†ã«è¨€ãˆã°ãã‚Œã ã‘SceneKitã‚„SpriteKitã«å·¦å³ã•ã‚Œãšã«å®Ÿè£…ã§ãã‚‹ã¨ã„ã†ã“ã¨ã«ãªã‚Šã¾ã™ã€‚

[Displaying an AR Experience with Metal](https://developer.apple.com/documentation/arkit/displaying_an_ar_experience_with_metal)ã¯ã“ã®å®Ÿè£…ã®è§£èª¬ã«ãªã£ã¦ã„ã¾ã™ã€‚

ï¼ˆå¾Œã»ã©è¿½è¨˜ã—ã¾ã™ã€‚ï¼‰